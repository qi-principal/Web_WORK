<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站管理</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .website-card {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .url-check-feedback {
            display: none;
            margin-top: 5px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">网站管理系统</h2>
        
        <!-- 创建网站表单 -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>添加新网站</h4>
            </div>
            <div class="card-body">
                <form id="createWebsiteForm">
                    <div class="mb-3">
                        <label for="websiteName" class="form-label">网站名称</label>
                        <input type="text" class="form-control" id="websiteName" name="websiteName" required>
                    </div>
                    <div class="mb-3">
                        <label for="websiteUrl" class="form-label">网站URL</label>
                        <input type="url" class="form-control" id="websiteUrl" name="websiteUrl" required>
                        <div class="url-check-feedback text-danger" id="urlFeedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="websiteDesc" class="form-label">网站介绍</label>
                        <textarea class="form-control" id="websiteDesc" name="websiteDesc" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">创建网站</button>
                </form>
            </div>
        </div>

        <!-- 网站列表 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">网站列表</h4>
                <button class="btn btn-secondary" onclick="loadWebsites()">刷新列表</button>
            </div>
            <div class="card-body">
                <div id="websitesList"></div>
            </div>
        </div>
    </div>

    <!-- 编辑网站模态框 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑网站信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editWebsiteForm">
                        <input type="hidden" id="editWebsiteId">
                        <div class="mb-3">
                            <label for="editWebsiteName" class="form-label">网站名称</label>
                            <input type="text" class="form-control" id="editWebsiteName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editWebsiteUrl" class="form-label">网站URL</label>
                            <input type="url" class="form-control" id="editWebsiteUrl" required>
                            <div class="url-check-feedback text-danger" id="editUrlFeedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editWebsiteDesc" class="form-label">网站介绍</label>
                            <textarea class="form-control" id="editWebsiteDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateWebsite()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载完成后加载网站列表
        document.addEventListener('DOMContentLoaded', function() {
            loadWebsites();
            setupUrlChecks();
        });

        // 设置URL检查
        function setupUrlChecks() {
            let urlCheckTimeout;
            document.getElementById('websiteUrl').addEventListener('input', function(e) {
                clearTimeout(urlCheckTimeout);
                urlCheckTimeout = setTimeout(() => checkUrl(e.target.value, 'urlFeedback'), 500);
            });

            document.getElementById('editWebsiteUrl').addEventListener('input', function(e) {
                clearTimeout(urlCheckTimeout);
                urlCheckTimeout = setTimeout(() => checkUrl(e.target.value, 'editUrlFeedback'), 500);
            });
        }

        // 检查URL是否存在
        function checkUrl(url, feedbackId) {
            if (!url) return;
            const feedback = document.getElementById(feedbackId);
            feedback.style.display = 'block';
            
            fetch(`/api/websites/check-url?url=${encodeURIComponent(url)}`)
                .then(response => response.json())
                .then(exists => {
                    feedback.textContent = exists ? '该URL已存在' : '';
                    feedback.style.display = exists ? 'block' : 'none';
                })
                .catch(error => {
                    feedback.textContent = '检查URL时出错';
                    feedback.style.display = 'block';
                });
        }

        // 创建网站
        document.getElementById('createWebsiteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const websiteData = {
                websiteName: document.getElementById('websiteName').value,
                websiteUrl: document.getElementById('websiteUrl').value,
                websiteDesc: document.getElementById('websiteDesc').value
            };

            fetch('/api/websites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(websiteData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.websiteId) {
                    alert('网站创建成功！');
                    loadWebsites();
                    document.getElementById('createWebsiteForm').reset();
                } else {
                    throw new Error(data);
                }
            })
            .catch(error => {
                alert('创建失败：' + error.message);
            });
        });

        // 加载网站列表
        function loadWebsites() {
            fetch('/api/websites')
                .then(response => response.json())
                .then(websites => {
                    const websitesList = document.getElementById('websitesList');
                    websitesList.innerHTML = '';
                    websites.forEach(website => {
                        websitesList.innerHTML += createWebsiteCard(website);
                    });
                })
                .catch(error => {
                    console.error('加载网站列表失败：', error);
                });
        }

        // 创建网站卡片HTML
        function createWebsiteCard(website) {
            return `
                <div class="website-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${website.websiteName}</h5>
                            <p><a href="${website.websiteUrl}" target="_blank">${website.websiteUrl}</a></p>
                            <p>${website.websiteDesc || '暂无描述'}</p>
                            <p>创建时间：${website.createdAt}</p>
                            <p>更新时间：${website.updatedAt}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary btn-sm" onclick='openEditModal(${JSON.stringify(website)})'>编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteWebsite(${website.websiteId})">删除</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 打开编辑模态框
        function openEditModal(website) {
            document.getElementById('editWebsiteId').value = website.websiteId;
            document.getElementById('editWebsiteName').value = website.websiteName;
            document.getElementById('editWebsiteUrl').value = website.websiteUrl;
            document.getElementById('editWebsiteDesc').value = website.websiteDesc || '';
            document.getElementById('editUrlFeedback').style.display = 'none';
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // 更新网站
        function updateWebsite() {
            const websiteId = document.getElementById('editWebsiteId').value;
            const websiteData = {
                websiteName: document.getElementById('editWebsiteName').value,
                websiteUrl: document.getElementById('editWebsiteUrl').value,
                websiteDesc: document.getElementById('editWebsiteDesc').value
            };

            fetch(`/api/websites/${websiteId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(websiteData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.websiteId) {
                    alert('网站更新成功！');
                    loadWebsites();
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                } else {
                    throw new Error(data);
                }
            })
            .catch(error => {
                alert('更新失败：' + error.message);
            });
        }

        // 删除网站
        function deleteWebsite(websiteId) {
            if (confirm('确定要删除这个网站吗？')) {
                fetch(`/api/websites/${websiteId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('网站删除成功！');
                        loadWebsites();
                    } else {
                        throw new Error('删除失败');
                    }
                })
                .catch(error => {
                    alert('删除失败：' + error.message);
                });
            }
        }
    </script>
</body>
</html> 